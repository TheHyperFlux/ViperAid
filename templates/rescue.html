<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ViperAid - Snake Rescue</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
    /* General */
    body {
        font-family: 'Roboto', sans-serif;
        background-color: #f5f5f5;
    }

    /* Navbar - Glassmorphism Style */
    .navbar {
        background: rgba(39, 174, 96, 0.85);
        backdrop-filter: blur(10px);
        padding: 1rem 2rem;
        border-radius: 0 0 20px 20px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    .navbar-brand {
        color: #fff !important;
        font-weight: 700;
        font-size: 1.8rem;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }

    .nav-link {
        color: #fff !important;
        font-weight: 500;
        margin-right: 15px;
        position: relative;
        transition: all 0.3s ease;
    }

    .nav-link::after {
        content: "";
        position: absolute;
        width: 0;
        height: 2px;
        background: #fff;
        bottom: -4px;
        left: 0;
        transition: width 0.3s ease;
    }

    .nav-link:hover::after {
        width: 100%;
    }

    .navbar-toggler {
        border: none;
        outline: none;
    }

    .navbar-toggler-icon {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(255, 255, 255, 1)' stroke-width='2' stroke-linecap='round' stroke-miterlimit='10' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        width: 1.5em;
        height: 1.5em;
        text-shadow: 0 0 4px rgba(0, 0, 0, 0.5); /* Added for better visibility */
    }

    /* Ensure toggler icon contrast on mobile */
    @media (max-width: 768px) {
        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(255, 255, 255, 1)' stroke-width='2' stroke-linecap='round' stroke-miterlimit='10' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
            filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.7)); /* Enhanced shadow for mobile */
        }
    }

    /* Container & Sections */
    .container {
        padding: 4rem 1rem;
    }

    .section-title {
        color: #2c3e50;
        margin-bottom: 2rem;
        font-weight: 600;
        text-align: center;
    }

    /* Card Styles */
    .card {
        border: none;
        background-color: white;
        padding: 2rem;
        margin-bottom: 2rem;
        border-radius: 15px;
        transition: transform 0.3s, box-shadow 0.3s;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
    }

    .card:hover {
        transform: scale(1.02);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    /* Forms */
    .form-group label {
        font-weight: 500;
        color: #2c3e50;
    }

    .form-control,
    .form-control-file {
        border-radius: 8px;
    }

    #snake-image-form,
    #request-rescue-form {
        margin-bottom: 2rem;
    }

    /* Map */
    #map {
        height: 400px;
        margin-top: 2rem;
        border-radius: 12px;
        overflow: hidden;
    }

    /* Buttons */
    .btn-primary {
        background-color: #27ae60;
        border: none;
        font-weight: 500;
        transition: background-color 0.3s ease;
    }

    .btn-primary:hover {
        background-color: #219653;
    }

    .btn-analyze {
        background-color: #f39c12;
        color: #fff;
        border: none;
        font-weight: 500;
        transition: background-color 0.3s ease;
    }

    .btn-analyze:hover {
        background-color: #e67e22;
    }

    .btn-secondary {
        background-color: #95a5a6;
        border: none;
    }

    /* Rescuer List */
    .rescuer-list {
        max-height: 300px;
        overflow-y: auto;
        border-radius: 10px;
    }

    .rescuer-list .list-group-item {
        transition: background-color 0.3s;
        cursor: pointer;
    }

    .rescuer-list .list-group-item:hover {
        background-color: #f8f9fa;
    }

    .rescuer-list .selected {
        background-color: #e0f7fa;
        font-weight: bold;
    }

    /* Animation */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
        animation: fadeIn 1s ease-in forwards;
    }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <a class="navbar-brand" href="/">ViperAid</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item"><a class="nav-link" href="/snakebite">Snake Bite</a></li>
                <li class="nav-item"><a class="nav-link" href="/rescue">Rescue</a></li>
                <li class="nav-item"><a class="nav-link" href="/info">Info</a></li>
            </ul>
        </div>
    </nav>
    <div class="container fade-in">
        <h2 class="section-title">Snake Rescue Assistance</h2>
        <div class="card">
            <h4>Identify Snake Species</h4>
            <form id="snake-image-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="snakeImage">Upload Snake Image (Optional)</label>
                    <input type="file" class="form-control-file" id="snakeImage" name="snakeImage" accept="image/*">
                </div>
                <button type="submit" class="btn btn-analyze">Analyze</button>
            </form>
            <div id="snake-result" class="mt-3"></div>
        </div>
        <div class="card">
            <h4>Request Snake Rescue</h4>
            <form id="request-rescue-form">
                <div class="form-group">
                    <label for="name">Name</label>
                    <input type="text" class="form-control" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" class="form-control" id="phone" name="phone" required>
                </div>
                <div class="form-group">
                    <label for="snakeSpecies">Snake Species (Optional)</label>
                    <input type="text" class="form-control" id="snakeSpecies" name="snakeSpecies">
                </div>
                <div class="form-group">
                    <label for="location">Location (Optional)</label>
                    <input type="text" class="form-control" id="location" name="location">
                    <button type="button" class="btn btn-secondary mt-2" id="getLocation">Use My Location</button>
                </div>
                <button type="submit" class="btn btn-primary">Request Rescue</button>
            </form>
        </div>
        <div class="card">
            <h4>Snake Rescuers in Nepal</h4>
            <ul class="list-group rescuer-list" id="rescuerList">
                {% for rescuer in rescuers %}
                    <li class="list-group-item" data-id="{{ rescuer.id }}" data-lat="{{ rescuer.latitude }}" data-lon="{{ rescuer.longitude }}">
                        {{ rescuer.name }} - {{ rescuer.phone }}
                        {% if rescuer.distance is not none %}
                            ({{ rescuer.distance | round(2) }} km)
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        </div>
        <div class="card">
            <h4>Nearby Rescuers</h4>
            <div id="map"></div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/openrouteservice-js@0.3.2/dist/ors-js.min.js"></script>
    <script>
        // Initialize Map with a general view of Nepal
        var map = L.map('map').setView([28, 84], 7); // Center on Nepal, zoom level 7
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // User marker (yellow)
        var yellowIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });
        var userMarker = null; // User marker is null until location is set

        // Rescuer markers
        var markers = {};
        var rescuers = document.querySelectorAll('.list-group-item');
        rescuers.forEach(function(rescuer) {
            var id = rescuer.getAttribute('data-id');
            var lat = parseFloat(rescuer.getAttribute('data-lat'));
            var lon = parseFloat(rescuer.getAttribute('data-lon'));
            markers[id] = L.marker([lat, lon], {
                icon: L.icon({ iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png', iconSize: [25, 41] })
            }).addTo(map).bindPopup(rescuer.innerText);
        });

        // Selected marker icon
        var selectedIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });

        // Route layer
        var currentRoute = null;

        // OpenRouteService API key
        var orsApiKey = '5b3ce3597851110001cf6248edc1a837793d4bb69b3050b23af98e19'; // Replace with your actual API key

        // Function to show route
        function showRoute(startLat, startLon, endLat, endLon) {
            if (!userMarker) {
                alert('Please set your location first.');
                return;
            }
            if (currentRoute) {
                map.removeLayer(currentRoute);
            }
            var ors = new OpenRouteService(orsApiKey);
            ors.calculate({
                coordinates: [[startLon, startLat], [endLon, endLat]],
                profile: 'driving-car',
                format: 'geojson'
            }).then(function(response) {
                currentRoute = L.geoJSON(response, {
                    style: { color: '#ff0000', weight: 5 }
                }).addTo(map);
                map.fitBounds(currentRoute.getBounds());
            }).catch(function(error) {
                console.error('Routing error:', error);
                alert('Unable to fetch route. Please check your OpenRouteService API key or try again later.');
            });
        }

        // Reset markers and list items
        function resetMarkers() {
            for (var id in markers) {
                markers[id].setIcon(L.icon({ iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png', iconSize: [25, 41] }));
            }
            document.querySelectorAll('.list-group-item').forEach(item => {
                item.classList.remove('selected');
            });
        }

        // Handle rescuer list clicks
        function attachRescuerClickListeners() {
            document.querySelectorAll('.list-group-item').forEach(rescuer => {
                rescuer.addEventListener('click', function() {
                    var id = rescuer.getAttribute('data-id');
                    var lat = parseFloat(rescuer.getAttribute('data-lat'));
                    var lon = parseFloat(rescuer.getAttribute('data-lon'));
                    resetMarkers();
                    markers[id].setIcon(selectedIcon);
                    rescuer.classList.add('selected');
                    map.setView([lat, lon], 15, { animate: true });
                    if (userMarker) {
                        showRoute(userMarker.getLatLng().lat, userMarker.getLatLng().lng, lat, lon);
                    }
                });
            });
        }

        // Initial rescuer click listeners
        attachRescuerClickListeners();

        // Function to fetch and update rescuers
        function fetchRescuers(lat, lon) {
            fetch(`/api/rescuers?lat=${lat}&lon=${lon}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    const rescuerList = document.getElementById('rescuerList');
                    rescuerList.innerHTML = ''; // Clear existing list
                    data.rescuers.forEach(rescuer => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.dataset.id = rescuer.id;
                        li.dataset.lat = rescuer.latitude;
                        li.dataset.lon = rescuer.longitude;
                        li.textContent = `${rescuer.name} - ${rescuer.phone} (${rescuer.distance.toFixed(2)} km)`;
                        rescuerList.appendChild(li);
                    });
                    updateMarkers(data.rescuers);
                    attachRescuerClickListeners();
                })
                .catch(error => {
                    console.error('Error fetching rescuers:', error);
                    alert('Failed to load rescuers. Please try again.');
                });
        }

        // Function to update markers
        function updateMarkers(rescuers) {
            for (var id in markers) {
                map.removeLayer(markers[id]);
            }
            markers = {};
            rescuers.forEach(rescuer => {
                var id = rescuer.id;
                var lat = rescuer.latitude;
                var lon = rescuer.longitude;
                markers[id] = L.marker([lat, lon], {
                    icon: L.icon({ iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png', iconSize: [25, 41] })
                }).addTo(map).bindPopup(`${rescuer.name} - ${rescuer.phone} (${rescuer.distance.toFixed(2)} km)`);
                markers[id].on('click', function() {
                    resetMarkers();
                    this.setIcon(selectedIcon);
                    var rescuerItem = document.querySelector(`.list-group-item[data-id="${id}"]`);
                    if (rescuerItem) {
                        rescuerItem.classList.add('selected');
                    }
                    map.setView(this.getLatLng(), 15, { animate: true });
                    if (userMarker) {
                        showRoute(userMarker.getLatLng().lat, userMarker.getLatLng().lng, this.getLatLng().lat, this.getLatLng().lng);
                    }
                });
            });
        }

        // Function to handle geolocation errors
        function handleGeolocationError(error) {
            let message;
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Location access denied. Please allow location access in your browser settings.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Location information is unavailable. Please check your device’s location services.';
                    break;
                case error.TIMEOUT:
                    message = 'Location request timed out. Please try again.';
                    break;
                default:
                    message = 'An unknown error occurred while retrieving your location.';
            }
            console.error(`Geolocation error: ${error.message} (Code: ${error.code})`);
            alert(message);
        }

        // Function to update location and refresh rescuer list
        function updateLocation(lat, lon) {
            console.log(`Updating location to: ${lat}, ${lon}`);
            if (!userMarker) {
                userMarker = L.marker([lat, lon], {
                    icon: yellowIcon
                }).addTo(map).bindPopup('Your Location');
            } else {
                userMarker.setLatLng([lat, lon]);
            }
            document.getElementById('location').value = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
            map.setView([lat, lon], 13);
            fetchRescuers(lat, lon);
        }

        // Get user location on page load
        window.onload = function() {
            console.log('Page loaded, checking for location...');
            const urlParams = new URLSearchParams(window.location.search);
            const lat = urlParams.get('lat');
            const lon = urlParams.get('lon');
            if (lat && lon) {
                try {
                    const latNum = parseFloat(lat);
                    const lonNum = parseFloat(lon);
                    if (!isNaN(latNum) && !isNaN(lonNum)) {
                        updateLocation(latNum, lonNum);
                    } else {
                        console.warn('Invalid URL coordinates:', lat, lon);
                    }
                } catch (e) {
                    console.error('Error parsing URL coordinates:', e);
                }
            } else if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    console.log('Geolocation success:', position.coords);
                    updateLocation(position.coords.latitude, position.coords.longitude);
                }, handleGeolocationError, {
                    enableHighAccuracy: true,
                    timeout: 10000, // 10 seconds
                    maximumAge: 0
                });
            } else {
                console.warn('Geolocation not supported by browser.');
                alert('Geolocation is not supported by your browser.');
            }
        };

        // Get User Location on button click
        document.getElementById('getLocation').addEventListener('click', function() {
            console.log('Use My Location button clicked');
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    console.log('Geolocation success:', position.coords);
                    updateLocation(position.coords.latitude, position.coords.longitude);
                }, handleGeolocationError, {
                    enableHighAccuracy: true,
                    timeout: 10000, // 10 seconds
                    maximumAge: 0
                });
            } else {
                console.warn('Geolocation not supported by browser.');
                alert('Geolocation is not supported by your browser.');
            }
        });

        // Image Upload
        document.getElementById('snake-image-form').addEventListener('submit', function(e) {
            e.preventDefault();
            var formData = new FormData(this);
            fetch('/predict', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('snake-result').innerHTML = `<p class="text-danger">Error: ${data.error}</p>`;
                } else {
                    document.getElementById('snakeSpecies').value = data.common_name;
                    document.getElementById('snake-result').innerHTML = `
                        <h5>Identified Snake</h5>
                        <p><strong>Common Name:</strong> ${data.common_name}</p>
                        <p><strong>Nepali Name:</strong> ${data.nepali_name}</p>
                        <p><strong>Danger Level:</strong> ${data.danger}</p>
                        <p><strong>Habitat:</strong> ${data.habitat}</p>
                        <p><strong>Confidence:</strong> ${data.confidence.toFixed(2)}%</p>
                    `;
                }
            })
            .catch(error => {
                console.error('Error identifying snake:', error);
                document.getElementById('snake-result').innerHTML = '<p class="text-danger">Error identifying snake.</p>';
            });
        });

        // Request Rescue Form Submission
        document.getElementById('request-rescue-form').addEventListener('submit', function(e) {
            e.preventDefault();
            var formData = new FormData(this);
            formData.append('request_type', 'rescue');
            var location = document.getElementById('location').value.trim();
            if (location && location.includes(',')) {
                var [lat, lon] = location.split(',').map(coord => coord.trim());
                formData.append('latitude', lat);
                formData.append('longitude', lon);
            }
            fetch('/submit_request', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert(data.message || 'Request submitted successfully!');
                    document.getElementById('request-rescue-form').reset();
                    document.getElementById('snake-result').innerHTML = '';
                    document.getElementById('location').value = '';
                }
            })
            .catch(error => {
                console.error('Form submission error:', error);
                alert('Error submitting request.');
            });
        });
    </script>
</body>
</html>